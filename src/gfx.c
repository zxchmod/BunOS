/* Mode 13h graphics, 5x7 font, widgets */
#include "gfx.h"
#include <stdint.h>

static uint8_t* const VGA = (uint8_t*)0xA0000;

typedef struct { char c; uint8_t col[5]; } Glyph;
static const Glyph FONT[] = {
  {' ', {0,0,0,0,0}},
  {'.', {0,0,0,0x18,0x18}},
  {'0', {0x3E,0x51,0x49,0x45,0x3E}},
  {'1', {0x00,0x42,0x7F,0x40,0x00}},
  {'2', {0x62,0x51,0x49,0x49,0x46}},
  {'3', {0x22,0x41,0x49,0x49,0x36}},
  {'4', {0x18,0x14,0x12,0x7F,0x10}},
  {'5', {0x27,0x45,0x45,0x45,0x39}},
  {'6', {0x3E,0x49,0x49,0x49,0x32}},
  {'7', {0x01,0x71,0x09,0x05,0x03}},
  {'8', {0x36,0x49,0x49,0x49,0x36}},
  {'9', {0x26,0x49,0x49,0x49,0x3E}},
  {'A',{0x7E,0x11,0x11,0x11,0x7E}},
  {'B',{0x7F,0x49,0x49,0x49,0x36}},
  {'C',{0x3E,0x41,0x41,0x41,0x22}},
  {'D',{0x7F,0x41,0x41,0x22,0x1C}},
  {'E',{0x7F,0x49,0x49,0x49,0x41}},
  {'F',{0x7F,0x09,0x09,0x09,0x01}},
  {'G',{0x3E,0x41,0x49,0x49,0x7A}},
  {'H',{0x7F,0x08,0x08,0x08,0x7F}},
  {'I',{0x00,0x41,0x7F,0x41,0x00}},
  {'J',{0x20,0x40,0x41,0x3F,0x01}},
  {'K',{0x7F,0x08,0x14,0x22,0x41}},
  {'L',{0x7F,0x40,0x40,0x40,0x40}},
  {'M',{0x7F,0x02,0x0C,0x02,0x7F}},
  {'N',{0x7F,0x04,0x08,0x10,0x7F}},
  {'O',{0x3E,0x41,0x41,0x41,0x3E}},
  {'P',{0x7F,0x09,0x09,0x09,0x06}},
  {'Q',{0x3E,0x41,0x51,0x21,0x5E}},
  {'R',{0x7F,0x09,0x19,0x29,0x46}},
  {'S',{0x26,0x49,0x49,0x49,0x32}},
  {'T',{0x01,0x01,0x7F,0x01,0x01}},
  {'U',{0x3F,0x40,0x40,0x40,0x3F}},
  {'V',{0x1F,0x20,0x40,0x20,0x1F}},
  {'W',{0x7F,0x20,0x18,0x20,0x7F}},
  {'X',{0x63,0x14,0x08,0x14,0x63}},
  {'Y',{0x07,0x08,0x70,0x08,0x07}},
  {'Z',{0x61,0x51,0x49,0x45,0x43}},
  {'a',{0x20,0x54,0x54,0x54,0x78}},
  {'b',{0x7F,0x48,0x44,0x44,0x38}},
  {'c',{0x38,0x44,0x44,0x44,0x20}},
  {'d',{0x38,0x44,0x44,0x48,0x7F}},
  {'e',{0x38,0x54,0x54,0x54,0x18}},
  {'f',{0x08,0x7E,0x09,0x01,0x02}},
  {'g',{0x08,0x54,0x54,0x54,0x3C}},
  {'h',{0x7F,0x08,0x04,0x04,0x78}},
  {'i',{0x00,0x44,0x7D,0x40,0x00}},
  {'j',{0x20,0x40,0x44,0x3D,0x00}},
  {'k',{0x7F,0x10,0x28,0x44,0x00}},
  {'l',{0x00,0x41,0x7F,0x40,0x00}},
  {'m',{0x7C,0x04,0x18,0x04,0x78}},
  {'n',{0x7C,0x08,0x04,0x04,0x78}},
  {'o',{0x38,0x44,0x44,0x44,0x38}},
  {'p',{0x7C,0x14,0x14,0x14,0x08}},
  {'q',{0x08,0x14,0x14,0x14,0x7C}},
  {'r',{0x7C,0x08,0x04,0x04,0x08}},
  {'s',{0x48,0x54,0x54,0x54,0x24}},
  {'t',{0x04,0x3F,0x44,0x40,0x20}},
  {'u',{0x3C,0x40,0x40,0x20,0x7C}},
  {'v',{0x1C,0x20,0x40,0x20,0x1C}},
  {'w',{0x3C,0x40,0x30,0x40,0x3C}},
  {'x',{0x44,0x28,0x10,0x28,0x44}},
  {'y',{0x0C,0x50,0x50,0x50,0x3C}},
  {'z',{0x44,0x64,0x54,0x4C,0x44}},
  {0,{0,0,0,0,0}}
};

static const Glyph* find_glyph(char c){
    const Glyph* g = FONT;
    while(g->c){
        if(g->c == c) return g;
        g++;
    }
    return FONT;
}

void gfx_set_mode13(){
    asm volatile("mov $0x0013, %%ax; int $0x10" ::: "ax");
}

void gfx_clear(uint8_t color){
    for(int i=0;i<WIDTH*HEIGHT;i++) VGA[i]=color;
}

void gfx_putpixel(int x,int y,uint8_t color){
    if((unsigned)x>=WIDTH || (unsigned)y>=HEIGHT) return;
    VGA[y*WIDTH + x] = color;
}

void gfx_fillrect(int x,int y,int w,int h,uint8_t color){
    for(int yy=0; yy<h; yy++){
        for(int xx=0; xx<w; xx++) gfx_putpixel(x+xx,y+yy,color);
    }
}

void gfx_drawrect(int x,int y,int w,int h,uint8_t color){
    for(int xx=0; xx<w; xx++){ gfx_putpixel(x+xx,y,color); gfx_putpixel(x+xx,y+h-1,color); }
    for(int yy=0; yy<h; yy++){ gfx_putpixel(x,y+yy,color); gfx_putpixel(x+w-1,y+yy,color); }
}

static void plot_glyph(int x,int y,const Glyph* g,uint8_t color){
    for(int col=0; col<5; col++){
        uint8_t bits = g->col[col];
        for(int row=0; row<7; row++){
            if(bits & (1<<row)) gfx_putpixel(x+col, y+row, color);
        }
    }
}

void gfx_text(int x,int y,const char* s,uint8_t color){
    int cx = x;
    while(*s){
        if(*s == '\n'){ y += 8; cx = x; s++; continue; }
        const Glyph* g = find_glyph(*s++);
        plot_glyph(cx, y, g, color);
        cx += 6;
    }
}

void gfx_logo_bread(int x,int y){
    uint8_t body=0x46, cap=0x3F, crust=0x6C, outline=0x00;
    gfx_fillrect(x+6,y,88,44, body);
    gfx_fillrect(x+10,y+4,80,16, cap);
    gfx_drawrect(x+6,y,88,44, outline);
    gfx_fillrect(x+24,y+22,12,4,crust);
    gfx_fillrect(x+44,y+19,12,4,crust);
    gfx_fillrect(x+64,y+22,12,4,crust);
}

void gfx_battery(int x,int y,int w,int h,int level){
    if(level<0) level=0; if(level>100) level=100;
    gfx_drawrect(x,y,w,h,0x00);
    gfx_fillrect(x+w, y+h/4, 4, h/2, 0x00);
    int inner = w-2;
    int fill = (inner * level)/100;
    uint8_t empty = 0x08;
    uint8_t fillcol = (level>60)?0x2A: (level>30?0x28:0x27);
    gfx_fillrect(x+1,y+1, inner, h-2, empty);
    if(fill>0) gfx_fillrect(x+1,y+1, fill, h-2, fillcol);
}

void gfx_button(int x,int y,int w,int h,const char* label,int focused){
    uint8_t bg = focused?0x1F:0x12;
    uint8_t fg = 0x3F;
    uint8_t br = focused?0x2F:0x00;
    gfx_fillrect(x,y,w,h,bg);
    gfx_drawrect(x,y,w,h,br);
    int len=0; for(const char* p=label; *p; ++p) len++;
    int tx = x + (w - len*6)/2; if(tx < x+2) tx = x+2;
    int ty = y + (h - 7)/2;
    gfx_text(tx, ty, label, fg);
}

void gfx_wallpaper_solid(uint8_t color){ gfx_clear(color); }

void gfx_wallpaper_gradient(){
    for(int y=0;y<HEIGHT;y++){
        uint8_t c = (y*3/2) & 0x3F;
        for(int x=0;x<WIDTH;x++) VGA[y*WIDTH + x] = 0x10 + (c & 0x2F);
    }
}

void gfx_wallpaper_checker(){
    for(int y=0;y<HEIGHT;y++){
        for(int x=0;x<WIDTH;x++){
            int cell = ((x>>4) ^ (y>>4)) & 1;
            VGA[y*WIDTH + x] = cell ? 0x14 : 0x18;
        }
    }
}
